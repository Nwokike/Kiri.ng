{% extends "core/base.html" %}
{% load i18n %}

{% block title %}{{ service.title }} - Kiri.ng{% endblock %}

{% block og_title %}{{ service.title }}{% endblock %}
{% block og_description %}{{ service.description|striptags|truncatewords:30 }}{% endblock %}
{% if service.get_all_images %}{% block og_image %}{{ service.get_all_images.0 }}{% endblock %}{% endif %}

{% block twitter_title %}{{ service.title }}{% endblock %}
{% block twitter_description %}{{ service.description|striptags|truncatewords:30 }}{% endblock %}
{% if service.get_all_images %}{% block twitter_image %}{{ service.get_all_images.0 }}{% endblock %}{% endif %}

{% block content %}
<div class="row">
    <div class="col-lg-8">
        <div class="card">
            {% if service.get_all_images %}
                <div id="serviceCarousel" class="carousel slide" data-bs-ride="carousel">
                    <div class="carousel-indicators">
                        {% for image_url in service.get_all_images %}
                        <button type="button" data-bs-target="#serviceCarousel" data-bs-slide-to="{{ forloop.counter0 }}" {% if forloop.first %}class="active" aria-current="true"{% endif %} aria-label="Slide {{ forloop.counter }}"></button>
                        {% endfor %}
                    </div>
                    <div class="carousel-inner">
                        {% for image_url in service.get_all_images %}
                        <div class="carousel-item {% if forloop.first %}active{% endif %}" style="cursor: pointer;" onclick="openImageFullscreen('{{ image_url }}')">
                            <img src="{{ image_url }}" class="d-block w-100" alt="{{ service.title }}" style="max-height: 500px; object-fit: cover;">
                        </div>
                        {% endfor %}
                    </div>
                    {% if service.get_all_images|length > 1 %}
                    <button class="carousel-control-prev" type="button" data-bs-target="#serviceCarousel" data-bs-slide="prev">
                        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">{% trans "Previous" %}</span>
                    </button>
                    <button class="carousel-control-next" type="button" data-bs-target="#serviceCarousel" data-bs-slide="next">
                        <span class="carousel-control-next-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">{% trans "Next" %}</span>
                    </button>
                    {% endif %}
                </div>
            {% endif %}
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h1 class="card-title">{{ service.title }}</h1>
                        <h4 class="card-subtitle mb-2 text-muted">₦{{ service.price|floatformat:2 }}</h4>
                    </div>
                    <button class="btn btn-outline-primary btn-sm" onclick="shareService()">
                        <i class="bi bi-share me-1"></i> {% trans "Share" %}
                    </button>
                </div>
                <p class="card-text"><small class="text-muted">{% trans "Offered by:" %} <a href="{% url 'users:artisan-storefront' service.artisan.username %}">{{ service.artisan.first_name }} {{ service.artisan.last_name }}</a></small></p>
                
                {% if service.artisan.profile.street_address or service.artisan.profile.city or service.artisan.profile.state %}
                <div class="mb-3">
                    <h6 class="mb-1"><i class="bi bi-geo-alt-fill text-primary"></i> {% trans "Location" %}</h6>
                    <p class="text-muted mb-1">
                        {% if service.artisan.profile.street_address %}{{ service.artisan.profile.street_address }}<br>{% endif %}
                        {% if service.artisan.profile.city %}{{ service.artisan.profile.city }}, {% endif %}{{ service.artisan.profile.state }}
                    </p>
                    {% if service.artisan.profile.street_address and service.artisan.profile.city %}
                    <a href="https://www.google.com/maps/search/?api=1&query={{ service.artisan.profile.street_address|urlencode }},+{{ service.artisan.profile.city|urlencode }},+{{ service.artisan.profile.state|urlencode }}" target="_blank" class="btn btn-outline-primary btn-sm">
                        <i class="bi bi-map"></i> {% trans "View on Google Maps" %}
                    </a>
                    {% endif %}
                </div>
                {% endif %}
                
                {% if service.artisan.profile.phone_number %}
                <div class="mt-2 mb-3">
                    <button id="revealPhoneService" class="btn btn-success btn-sm" onclick="revealPhoneService()">
                        <i class="bi bi-telephone-fill me-1"></i> {% trans "Reveal Contact Number" %}
                    </button>
                    <span id="phoneNumberService" class="ms-2 fw-bold" style="display: none;">{{ service.artisan.profile.phone_number }}</span>
                </div>
                <script>
                function revealPhoneService() {
                    document.getElementById('revealPhoneService').style.display = 'none';
                    document.getElementById('phoneNumberService').style.display = 'inline';
                }
                </script>
                {% endif %}
                
                <hr><h5 class="mt-4">{% trans "Description" %}</h5><p>{{ service.description|linebreaksbr }}</p>
            </div>
        </div>

        {% if recommended_services %}
        <div class="mt-5">
            <h3 class="mb-3">{% trans "You Might Also Like" %}</h3>
            <div class="row">
                {% for rec_service in recommended_services %}
                <div class="col-md-6 mb-4">
                    <div class="card h-100">
                        {% if rec_service.image %}<img src="{{ rec_service.image.url }}" class="card-img-top service-detail-img" alt="{{ rec_service.title }}">{% endif %}
                        <div class="card-body d-flex flex-column">
                            <h5 class="card-title">{{ rec_service.title }}</h5>
                            <p class="card-text"><small class="text-muted">by {{ rec_service.artisan.username }}</small></p>
                            <a href="{% url 'marketplace:service-detail' pk=rec_service.pk %}" class="btn btn-outline-secondary mt-auto">{% trans "View Service" %}</a>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>

    <div class="col-lg-4">
        <div class="card position-sticky" style="top: 140px;">
            <div class="card-header"><h4>{% trans "Book This Service" %}</h4></div>
            <div class="card-body"><form method="post">{% csrf_token %}{{ form.as_p }}<div class="d-grid"><button type="submit" class="btn btn-primary">{% trans "Send Request" %}</button></div></form></div>
        </div>
    </div>
</div>

<div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-xl">
        <div class="modal-content bg-transparent border-0">
            <div class="modal-body p-0 position-relative">
                <button type="button" class="btn-close position-absolute top-0 end-0 m-3 bg-white" data-bs-dismiss="modal" aria-label="Close" style="z-index: 1060;"></button>
                <img id="fullscreenImage" src="" class="img-fluid w-100" alt="Fullscreen view">
                {% if service.get_all_images|length > 1 %}
                <button class="btn btn-light position-absolute start-0 top-50 translate-middle-y ms-3" onclick="navigateFullscreenImage(-1)" style="z-index: 1060; opacity: 0.8;">
                    <i class="bi bi-chevron-left fs-3"></i>
                </button>
                <button class="btn btn-light position-absolute end-0 top-50 translate-middle-y me-3" onclick="navigateFullscreenImage(1)" style="z-index: 1060; opacity: 0.8;">
                    <i class="bi bi-chevron-right fs-3"></i>
                </button>
                <div class="position-absolute bottom-0 start-50 translate-middle-x mb-3 bg-dark bg-opacity-50 text-white px-3 py-1 rounded" style="z-index: 1060;">
                    <span id="imageCounter">1 / {{ service.get_all_images|length }}</span>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
const serviceImages = [
    {% for image_url in service.get_all_images %}
    '{{ image_url|escapejs }}'{% if not forloop.last %},{% endif %}
    {% endfor %}
];
let currentImageIndex = 0;

function shareService() {
    const shareData = {
        title: '{{ service.title|escapejs }}',
        text: '{{ service.description|truncatewords:20|escapejs }} - ₦{{ service.price }}',
        url: window.location.href
    };
    
    if (navigator.share) {
        navigator.share(shareData).catch(err => console.log('Error sharing:', err));
    } else {
        const shareUrl = window.location.href;
        navigator.clipboard.writeText(shareUrl).then(() => {
            alert('{% trans "Link copied to clipboard!" %}');
        }).catch(err => {
            prompt('{% trans "Copy this link:" %}', shareUrl);
        });
    }
}

function openImageFullscreen(imageUrl) {
    currentImageIndex = serviceImages.indexOf(imageUrl);
    updateFullscreenImage();
    const imageModal = new bootstrap.Modal(document.getElementById('imageModal'));
    imageModal.show();
}

function navigateFullscreenImage(direction) {
    currentImageIndex = (currentImageIndex + direction + serviceImages.length) % serviceImages.length;
    updateFullscreenImage();
}

function updateFullscreenImage() {
    const fullscreenImg = document.getElementById('fullscreenImage');
    fullscreenImg.src = serviceImages[currentImageIndex];
    
    const counterElement = document.getElementById('imageCounter');
    if (counterElement) {
        counterElement.textContent = `${currentImageIndex + 1} / ${serviceImages.length}`;
    }
}
</script>
{% endblock %}